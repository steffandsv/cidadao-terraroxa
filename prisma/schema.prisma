// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  phone      String   @unique @db.VarChar(20)
  name       String?  @db.VarChar(255)
  role       String   @default("USER") @db.VarChar(20)
  levelTitle String?  @default("Visitante") @map("level_title") @db.VarChar(50)
  createdAt  DateTime @default(now()) @map("created_at")

  // Verification Data
  fullName           String?  @map("full_name") @db.VarChar(255)
  cpf                String?  @unique @db.VarChar(14)
  addressStreet      String?  @map("address_street") @db.VarChar(255)
  addressNumber      String?  @map("address_number") @db.VarChar(20)
  addressZip         String?  @map("address_zip") @db.VarChar(10)
  city               String?  @default("Terra Roxa") @db.VarChar(100)
  state              String?  @default("SP") @db.VarChar(2)
  verificationStatus String   @default("NONE") @map("verification_status") @db.VarChar(20) // NONE, PENDING, APPROVED, REJECTED
  rejectionReason    String?  @map("rejection_reason") @db.Text

  actions      UserAction[]
  pointsLedger PointsLedger[]

  @@map("users")
}

model AssetType {
  id     Int    @id @default(autoincrement())
  name   String @unique @db.VarChar(50) // e.g., 'Poste', 'Pra√ßa'
  icon   String? @db.VarChar(50) // e.g., 'lucide-lightbulb', 'lucide-tree'
  schema Json?  @db.Json // JSON Schema defining extra fields (e.g., { "hasHistory": true, "fields": [...] })

  assets Asset[]

  @@map("asset_types")
}

model Asset {
  id                 Int      @id @default(autoincrement())
  assetTypeId        Int      @default(1) @map("asset_type_id")
  hashCode           String   @unique @map("hash_code") @db.VarChar(50)
  geoLat             Decimal? @map("geo_lat") @db.Decimal(10, 8)
  geoLng             Decimal? @map("geo_lng") @db.Decimal(11, 8)
  description        String?  @db.Text

  // Dynamic data based on AssetType schema
  data               Json?    @db.Json

  assetType AssetType    @relation(fields: [assetTypeId], references: [id])
  actions   UserAction[]

  @@map("assets")
}

model GamificationRule {
  slug             String  @id @db.VarChar(50)
  title            String? @db.VarChar(100) // Friendly name
  points           Int
  icon             String? @db.VarChar(50)

  // Mission Requirements
  requiresLocation Boolean @default(true) @map("requires_location")
  requiresPhoto    Boolean @default(true) @map("requires_photo")

  // AI Integration
  aiValidation     Boolean @default(false) @map("ai_validation")
  aiPrompt         String? @db.Text @map("ai_prompt") // "Analyze if this photo shows a clean backyard..."

  actions UserAction[]

  @@map("gamification_rules")
}

model UserAction {
  id          Int      @id @default(autoincrement())
  userId      Int?     @map("user_id")
  assetId     Int?     @map("asset_id") // Made nullable for general quests
  ruleSlug    String   @map("rule_slug") @db.VarChar(50)
  evidenceUrl String?  @map("evidence_url") @db.Text
  data        Json?    @db.Json
  status      String?  @default("PENDING") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at")

  user   User?            @relation(fields: [userId], references: [id])
  asset  Asset?           @relation(fields: [assetId], references: [id])
  rule   GamificationRule @relation(fields: [ruleSlug], references: [slug])
  ledger PointsLedger[]
  feedback String? @db.Text

  @@map("user_actions")
}

model Config {
  key   String @id @db.VarChar(50)
  value Json   @db.Json

  @@map("configs")
}

model PointsLedger {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  actionId    Int?     @map("action_id")
  amount      Int
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  user   User        @relation(fields: [userId], references: [id])
  action UserAction? @relation(fields: [actionId], references: [id])

  @@map("points_ledger")
}
